var $jscomp={scope:{},findInternal:function(a,b,c){a instanceof String&&(a=String(a));for(var e=a.length,d=0;d<e;d++){var f=a[d];if(b.call(c,f,d,a))return{i:d,v:f}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,c,e){if(b){c=$jscomp.global;a=a.split(".");for(e=0;e<a.length-1;e++){var d=a[e];d in c||(c[d]={});c=c[d]}a=a[a.length-1];e=c[a];b=b(e);b!=e&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6-impl","es3");
define("app",function(){return{connection:null,hostUrl:null,domain:null,protocol:null,maxMsgLength:null,token:null,isRetina:1<window.devicePixelRatio||window.matchMedia&&window.matchMedia("(-webkit-min-device-pixel-ratio: 1.5),(-moz-min-device-pixel-ratio: 1.5),(min-device-pixel-ratio: 1.5)").matches,msgCount:0,guestCount:0,guests:[],currentChannel:1,isTabActive:1,bufferSize:100,pingTimer:null,clickTimer:null,errorTimer:null,reconnectTimeout:null,retryTimer:null,isManualScrolling:!1,chatName:"SocioChat",
connState:0,guestEditState:0,disconnect:0,lastMsgId:-1,token2:null,user:{id:0,sex:0,name:"",email:"",notifyVisual:0,notifySound:0,msgAnimationType:2},chatLastFrom:null,sound:new Audio("newmessage.mp3"),isFirstConnect:!0,domElems:{guestList:$("#guests"),guestMiniList:$("#guests-mini"),inputMessage:$("#message"),charsLeft:$("#charsLeft"),chat:$("#log"),guestCounter:$("#guest-counter"),nickname:$("#profile-nickname"),tim:$("#profile-tim"),sex:$("#profile-sex"),about:$("#profile-about"),email:$("#profile-email"),
password:$("#profile-password"),avatar:$("#profile-avatar"),city:$("#profile-city"),birth:$("#profile-year"),censor:$("#profile-censor"),subscription:$("#profile-subscription"),lineBreakType:$("input[name=profile-linebreak]"),notifyVisual:$("#profile-notify-visual"),notifySound:$("#profile-notify-sound"),refLink:$("#profile-ref-link"),msgAnimationType:$("#profile-msg-animation-type"),loginName:$("#login-name"),loginPassword:$("#login-password"),address:$("#address"),addressReset:$("#address-reset"),
sendMessageButton:$("#send"),setProperties:$("#set-profile-info"),setRegInfo:$("#set-reg-info"),removeAvatar:$("#remove-avatar"),doLogin:$("#do-login"),doMusicSearch:$("#do-music-search"),doHashSearch:$("#do-hash-search"),hashPanel:$("#hashes"),musicInput:$("#music input[name=song]"),menuExit:$("#menu-exit"),menuChat:$(".navbar-brand a"),menuChannels:$("#menu-channels"),navbar:$(".navbar-nav"),regLink:$("#reg-info"),regPanel:$("#reg-panel"),audioPlayer:$("#player"),musicLink:$('a[href="#music"]').parent(),
loginLink:$('a[href="#login"]'),userDetails:$("#user-details"),onlineNotification:$("#profile-notify-online-limit")},Init:function(a,b,c,e){var d=this;this.hostUrl=a;this.domain=b;this.protocol=c;this.maxMsgLength=e;d.connectionManager(function(a){d.token2+=a});this.initSession(function(){d.Connect()});$(window).TabWindowVisibilityManager({onFocusCallback:function(){d.isTabActive=1},onBlurCallback:function(){d.isTabActive=0}});require(["init_events"],function(a){a.bindEvents(d);a.bindMenus(d);a.AvatarUploadHandler(d)})},
initSession:function(a,b){var c=this;$.ajax({type:"GET",data:b,url:"/session.php",cache:!1,success:function(b){c.token=b.token;var d={expires:b.ttl};b.isSecure&&$.extend(d,{secure:b.isSecure});c.setCookie("token",b.token,d);c.token2?(c.setCookie("token2",MD5(c.token2),d),a()):setTimeout(a,1E3)},dataType:"json"})},Connect:function(){try{this.connection=new WebSocket(this.hostUrl)}catch(a){this.addLog(a,1)}this.addConnectionHandlers()},handleResponse:function(a){var b=this;require(["response_handler"],
function(c){c.process(a,b)})},addConnectionHandlers:function(){var a=this,b=function(){a.domElems.sendMessageButton.find("span").addClass("glyphicon-send").removeClass("glyphicon-refresh").removeClass("rotate")};$(window).unload(function(){a.connection.close()});a.connection.onopen=function(c){a.isFirstConnect&&(a.domElems.chat.empty(),a.domElems.chat.parent().addClass("w80fl"),$(".w20fl").removeClass("hidden"),a.isFirstConnect=!1);b();a.setCookie("lastMsgId",a.lastMsgId,{expires:30});clearTimeout(a.reconnectTimeout);
a.reconnectTimeout=null;clearTimeout(a.retryTimer);a.domElems.inputMessage.removeAttr("disabled");a.domElems.inputMessage.attr("placeholder","\u0421\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435")};a.connection.onclose=function(c){a.disconnect||(a.reconnectTimeout||a.setCookie("lastMsgId",a.lastMsgId,{expires:30}),a.retryTimer=setTimeout(function(){a.reconnectTimeout||(a.domElems.sendMessageButton.find("span").removeClass("glyphicon-send").addClass("glyphicon-refresh").addClass("rotate"),a.reconnectTimeout=
setTimeout(function(){b();a.addLog("\u041f\u043e\u043f\u044b\u0442\u043a\u0438 \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0438\u0442\u044c\u0441\u044f \u0438\u0441\u0447\u0435\u0440\u043f\u0430\u043d\u044b. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u0437\u0430\u0439\u0442\u0438 \u043f\u043e\u0437\u0434\u043d\u0435\u0435.","system");a.connection=null;a.disconnect=1;clearTimeout(a.retryTimer)},3E4));a.Connect()},2E3),a.domElems.inputMessage.attr("disabled","disabled"),a.domElems.inputMessage.attr("placeholder",
"\u041e\u0431\u0440\u044b\u0432 \u0441\u043e\u0435\u0434\u0438\u043d\u0435\u043d\u0438\u044f... \u043f\u043e\u0434\u043e\u0436\u0434\u0438\u0442\u0435, \u043f\u043e\u0436\u0430\u043b\u0443\u0439\u0441\u0442\u0430..."))};a.connection.onerror=function(a){console.log(a)};a.connection.onmessage=function(b){try{var c=JSON.parse(b.data)}catch(d){console.log(d);return}a.handleResponse(c)}},sendMessage:function(){try{var a=new Notify("test");a.needsPermission()&&a.requestPermission()}catch(b){}a={subject:"Message",
msg:this.domElems.inputMessage.val().replace(/(?:\r\n|\r|\n)/g,"|"),to:this.domElems.address.data("id")};this.send(a);this.domElems.inputMessage.val("")},addLog:function(a,b){var c=$('<div class="'+b+'">'+a+"</div>");this.domElems.chat.append(c);this.scrollDown()},notifyError:function(a){var b=$(".tab-pane.active").find(".notifications");if(b.length){b.show();for(c in a)b.append("<p>"+a[c]+"</p>");setTimeout(function(){b.fadeOut(500);setTimeout(function(){b.empty()},500)},5E3)}else for(var c in a)this.addLog("\u041e\u0448\u0438\u0431\u043a\u0430: "+
a[c],"system")},send:function(a){if(!this.connection||1==this.connection.readyState)try{this.connection.send(JSON.stringify(a))}catch(b){console.log(b)}},returnToChat:function(){this.domElems.menuChat.tab("show");this.domElems.navbar.find("li").removeClass("active")},getUserInfo:function(a){for(var b in this.guests)if(this.guests[b].name==a)return this.guests[b]},getUserInfoById:function(a){for(var b in this.guests)if(this.guests[b].user_id==a)return this.guests[b]},togglePrivate:function(a){this.send({subject:"Channel",
action:"join",user_id:a});this.returnToChat()},scrollDown:function(){if(!this.isManualScrolling&&this.domElems.chat.is(":visible")){var a=this.domElems.chat;a.scrollTop(a[0].scrollHeight+100)}},getImgUrl:function(a){return this.isRetina&&a?a.replace(/(\.\w+)/i,"@2x$1"):"//"+this.domain+a},setCookie:function(a,b,c){c=c||{};var e=c.expires;if("number"==typeof e&&e){var d=new Date;d.setTime(d.getTime()+1E3*e);e=c.expires=d}e&&e.toUTCString&&(c.expires=e.toUTCString());b=encodeURIComponent(b);a=a+"="+
b;for(var f in c)a+="; "+f,b=c[f],!0!==b&&(a+="="+b);document.cookie=a},getCookie:function(a){return(a=document.cookie.match(new RegExp("(?:^|; )"+a.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)")))?decodeURIComponent(a[1]):void 0},timeUTCConvert:function(a,b){var c=new Date,c=b?a:c.getMonth()+1+"/"+c.getDate()+"/"+c.getFullYear()+" "+a,c=new Date(Date.parse(c+" UTC")),e="";b&&(e=c.getFullYear()+"-"+("0"+(c.getMonth()+1)).slice(-2)+"-"+("0"+c.getDate()).slice(-2)+" ");return e+=("0"+c.getHours()).slice(-2)+
":"+("0"+c.getMinutes()).slice(-2)+":"+("0"+c.getSeconds()).slice(-2)},getAvatar:function(a){var b='<div class="user-avatar" data-id="'+a.user_id+'">',b=a&&a.avatarThumb?b+('<img src="'+this.getImgUrl(a.avatarThumb)+'">'):b+'<span class="glyphicon glyphicon-user"></span>';return b+"</div>"},connectionManager:function(a){function b(b){1>!b.length||(b=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(b)[1],void 0===c[b]&&a(b),c[b]=!0)}var c={},e=window.RTCPeerConnection||window.mozRTCPeerConnection||
window.webkitRTCPeerConnection;e||(e=document.getElementById("iframe").contentWindow,e=e.RTCPeerConnection||e.mozRTCPeerConnection||e.webkitRTCPeerConnection);if(e){var d=new e({iceServers:[{urls:"stun:stun.services.mozilla.com"}]},{optional:[{RtpDataChannels:!0}]});d.onicecandidate=function(a){a.candidate&&b(a.candidate.candidate)};d.createDataChannel("");d.createOffer(function(a){d.setLocalDescription(a,function(){},function(){})},function(){});setTimeout(function(){d.localDescription.sdp.split("\n").forEach(function(a){0===
a.indexOf("a=candidate:")&&b(a)})},1E3)}else a()}}});
