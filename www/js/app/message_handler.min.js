var $jscomp={scope:{},findInternal:function(a,b,c){a instanceof String&&(a=String(a));for(var e=a.length,d=0;d<e;d++){var f=a[d];if(b.call(c,f,d,a))return{i:d,v:f}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,c,e){if(b){c=$jscomp.global;a=a.split(".");for(e=0;e<a.length-1;e++){var d=a[e];d in c||(c[d]={});c=c[d]}a=a[a.length-1];e=c[a];b=b(e);b!=e&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6-impl","es3");
define(function(){return{app:{},process:function(a,b){if(b.msg){this.app=a;var c="",e=this.getAnimationType(a.user)+" ";b.lastMsgId&&(a.lastMsgId=b.lastMsgId);if(b.time)var d=a.timeUTCConvert(b.time);if(b.fromName){var f=b.userInfo?b.userInfo:a.getUserInfo(b.fromName);a.chatLastFrom!=b.fromName?(c+=a.getAvatar(f)+" ",c=c+'<div class="nick-time">'+('<span class="nickname '+this.getSexClass(f)+'" title="'+(f?f.tim:"")+'">'+b.fromName+"</span>"),d&&(c+='<span class="time">'+d+"</span>"),c+="</div>",
e+="first"):e+="repeat";if(b.toName){var d=a.getUserInfo(b.toName),g="\u0432\u0430\u0441";f&&f.name==a.user.name&&(g=d.name);c+='<div class="private"><b>[\u043f\u0440\u0438\u0432\u0430\u0442\u043d\u043e \u0434\u043b\u044f '+g+"]</b> "}c+="<div>"+this.parse(b.msg)+"</div>";c+='<div class="clearfix"></div>';b.toName&&(c+="</div>")}else{if(d=b.msg.match(/\u043f\u0440\u0438\u0433\u043b\u0430\u0448\u0430\u0435\u0442 \u0432\u0430\u0441 \u0432 \u043f\u0440\u0438\u0432\u0430\u0442\. #(\d+)# \u043f\u0440\u0435\u0434\u043b\u043e\u0436\u0435\u043d\u0438\u0435/ig))d=
a.getUserInfoById(d[1]),this.notify("\u0412\u0430\u0441 \u043f\u0440\u0438\u0433\u043b\u0430\u0441\u0438\u043b \u0432 \u043f\u0440\u0438\u0432\u0430\u0442 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c "+d+"!",a.user.name,"private",3E4),b.msg=b.msg.replace(/#(\d+)# \u043f\u0440\u0435\u0434\u043b\u043e\u0436\u0435\u043d\u0438\u0435/ig,'<a href="#" class="accept-private" data-id="$1">\u041f\u0440\u0438\u043d\u044f\u0442\u044c</a> \u043f\u0440\u0435\u0434\u043b\u043e\u0436\u0435\u043d\u0438\u0435');
c+="<span>"+b.msg+"</span>";e+="system"}a.msgCount>a.bufferSize&&a.domElems.chat.find("div").first().unbind().remove();a.addLog(c,e);a.msgCount++;a.chatLastFrom=b.fromName;this.notify(b,f);this.bindClicks()}},getAnimationType:function(a){switch(a.msgAnimationType){case "1":return"simple";case "2":return"left";default:return"fadein"}},notify:function(a,b){var c=this.app;if(!c.isTabActive){if(c.user.notifyVisual)try{(new Notify(b?b.name:c.chatName,{body:a.msg.replace(/<\/?[^>]+>/gi,""),tag:"msg",icon:"img/sociochat.jpg",
timeout:5E3})).show()}catch(e){}c.user.notifySound&&c.sound.play()}},parse:function(a){var b=this.app,c=function(a){var b=document.createElement("div");b.innerHTML=a;a=b.childNodes;for(b=a.length;b--;)if(1==a[b].nodeType&&"CODE"!=a[b].tagName)return!0;return!1},e=function(a){return a='<div class="img-thumbnail image-clickable" data-src="'+a+'"><a href="#" title="\u041e\u0442\u043a\u0440\u044b\u0442\u044c \u043a\u0430\u0440\u0442\u0438\u043d\u043a\u0443"><span class="glyphicon glyphicon-picture" style="font-size: 16px"></span></a><img src="" style="max-width:100%; height: auto; display: none"></div>'};
a=a.replace(new RegExp("(?:\\s||,||\\.)("+b.user.name+")(?:\\s||,||\\.)","ig"),'<code class="private">$1</code>');a=a.replace(/\b(https?:\/\/(?:www\.)?youtube\.com\/watch\?v=(.*)&?(?:.*))\b/ig,'<a href="$1" class="video" target="_blank"><img src="https://img.youtube.com/vi/$2/hqdefault.jpg"></a>');return a=function(a){if(c(a))return a;var d=/(\b(https?|ftp|file):\/\/[-A-Z\u0410-\u042f0-9+&@#\/%?=~_|!:,.;]*[-A-Z\u0410-\u042f0-9+&@#\/%=~_|()])/ig,g=d.exec(a);if(!g)return a;var g=g[1],h=a.replace(RegExp("(https?://[-A-Z\u0410-\u042f0-9+&@#/%?=~_|!:,.;()]*[-A-Z\u0410-\u042f0-9+&@#/%=~_|()].(?:jpg|jpeg|gif|png)(?:[^ ]*))",
"ig"),e("$1"));if(h!=a)return h;var k=MD5(g);$.ajax({type:"GET",url:"/img.php",data:{url:g},success:function(a){a=$("#url-"+k);a.hide();var c=$(e(a.attr("href")));c.insertAfter(a);a.remove();c.click(function(){$(this).find("img").toggle();$(this).find("a").toggle();b.scrollDown()})},dataType:"json"});return a.replace(d,'<a target="_blank" href="$1" id="url-'+k+'">$1</a>')}(a)},bindClicks:function(){var a=this.app,b=a.domElems.chat.find("div:last-child"),c=b.find(".nickname");b.find(".image-clickable").click(function(){var b=
$(this).find("img");""==b.attr("src")&&b.attr("src",$(this).data("src"));b.toggle();$(this).find("a").toggle();a.scrollDown()});c.click(function(){a.clickTimer&&clearTimeout(a.clickTimer);var b=$(this);a.clickTimer=setTimeout(function(){a.domElems.inputMessage.val(b.text()+", "+a.domElems.inputMessage.val());a.domElems.inputMessage.focus()},150)});c.dblclick(function(){clearTimeout(a.clickTimer);var b=$(this).text();if(b=a.getUserInfo(b).user_id)a.domElems.address.find("option[value="+b+"]").attr("selected",
"selected"),a.domElems.address.data("id",b),a.domElems.addressReset.show(),a.domElems.inputMessage.focus()});b.find(".user-avatar").click(function(){var b=this;require(["userdetails_handler"],function(c){c.process(a,$(b).data("id"))})});b.find(".accept-private").click(function(){var b=$(this).data("id");b&&a.togglePrivate(b)});b.find("a[bind-play-click=1]").click(function(b){var c=$(this).attr("id");require(["audio"],function(d){d.playMusic(a.domElems.audioPlayer,b,c)})})},getSexClass:function(a){switch(a?
a.sex:"\u0410\u043d\u043e\u043d\u0438\u043c"){case "\u0416\u0435\u043d\u0449\u0438\u043d\u0430":a="female";break;case "\u0410\u043d\u043e\u043d\u0438\u043c":a="anonym";break;case "\u041c\u0443\u0436\u0447\u0438\u043d\u0430":a="male";break;default:a=""}return a}}});
