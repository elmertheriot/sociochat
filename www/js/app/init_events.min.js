var $jscomp={scope:{},findInternal:function(a,c,b){a instanceof String&&(a=String(a));for(var d=a.length,f=0;f<d;f++){var e=a[f];if(c.call(b,e,f,a))return{i:f,v:e}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,b){if(b.get||b.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[c]=b.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,c,b,d){if(c){b=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var f=a[d];f in b||(b[f]={});b=b[f]}a=a[a.length-1];d=b[a];c=c(d);c!=d&&null!=c&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6-impl","es3");
define(function(){return{bindEvents:function(a){a.pingTimer=setInterval(function(){a.connection&&1==a.connection.readyState&&a.send({subject:"Ping"})},15E3);a.domElems.addressReset.click(function(){a.domElems.address.children().first().attr("selected","selected");a.domElems.address.data("id","");a.domElems.addressReset.hide()});a.domElems.address.on("change",function(){a.domElems.address.data("id",this.value);this.value?a.domElems.addressReset.show():a.domElems.addressReset.hide()});a.domElems.sendMessageButton.click(function(){a.sendMessage();
a.domElems.inputMessage.focus()});a.domElems.inputMessage.keypress(function(b){var d=b.keyCode||b.which,d=10==d||13==d,c=this.value,e=b.ctrlKey&&d,g=e,h=d;a.domElems.charsLeft.text(a.maxMsgLength-c.length);0==a.user.lineBreakType&&(g=d&&!b.ctrlKey,h=e);if(g)return b=c.match(/(?:\r\n|\r|\n)/g),!(b&&3<b.length);if(h)return a.sendMessage(),a.domElems.charsLeft.text(a.maxMsgLength),!1});a.domElems.setProperties.click(function(b){b={subject:"Properties",action:"submit",tim:a.domElems.tim.val(),sex:a.domElems.sex.val(),
name:a.domElems.nickname.val(),city:a.domElems.city.val(),birth:a.domElems.birth.val(),about:a.domElems.about.val(),censor:a.domElems.censor.prop("checked")?a.domElems.censor.prop("checked"):!1,is_subscribed:a.domElems.subscription.prop("checked")?a.domElems.subscription.prop("checked"):!1,notify_visual:a.domElems.notifyVisual.prop("checked")?a.domElems.notifyVisual.prop("checked"):!1,notify_sound:a.domElems.notifySound.prop("checked")?a.domElems.notifySound.prop("checked"):!1,line_break_type:a.domElems.lineBreakType.filter(":checked").val()?
a.domElems.lineBreakType.filter(":checked").val():0,online_limit:a.domElems.onlineNotification.val()?a.domElems.onlineNotification.val():0,message_animation_type:a.domElems.msgAnimationType.val()?a.domElems.msgAnimationType.val():2};a.send(b);a.returnToChat()});a.domElems.removeAvatar.click(function(b){a.send({subject:"Properties",action:"removeAvatar"});a.domElems.avatar.find(".avatar-placeholder").html('<div class="user-avatar"><span class="glyphicon glyphicon-user"></span></div>')});a.domElems.setRegInfo.click(function(b){b=
{subject:"Login",action:"register",login:a.domElems.email.val(),password:a.domElems.password.val()};a.send(b);a.domElems.password.val("");a.returnToChat()});a.domElems.doLogin.click(function(b){b={subject:"Login",action:"enter",login:a.domElems.loginName.val(),password:a.domElems.loginPassword.val()};a.send(b);a.domElems.loginPassword.val("");a.returnToChat()});a.domElems.doMusicSearch.click(function(b){require(["audio"],function(b){b.process(a)})});a.domElems.musicInput.on("keypress",function(b){13==
b.which&&require(["audio"],function(b){b.process(a)})});$(window).resize(function(){a.scrollDown()});var c=function(){var b=a.domElems.chat;b[0].scrollTop>b[0].scrollHeight-1.5*b.height()&&(a.isManualScrolling=!1)};a.domElems.chat.on("touchstart",function(){a.isManualScrolling=!0});a.domElems.chat.on("touchstop",function(){c()});a.domElems.chat.on("mousewheel",function(){a.isManualScrolling=!0;$.data(this,"timer");clearTimeout($.data(this,"timer"));$.data(this,"timer",setTimeout(function(){c()},250))})},
bindMenus:function(a){a.domElems.menuExit.click(function(c){a.send({subject:"MainChat"})});a.domElems.menuChat.click(function(){a.returnToChat()});$(".tab-panel").click(function(a){a.preventDefault();$(this).tab("show")});$(".return-to-chat").click(function(){a.returnToChat()})},AvatarUploadHandler:function(a){var c=a.domElems.avatar,b=c.find(".do-upload"),d=c.find(".alert"),f=c.find(".avatar-placeholder"),e=null,g=null,h=null;c.find(".upload").change(function(a){h=this.files[0];a=new FileReader;
var c=new Image;g&&g.destroy();e=$("<div></div>");e.attr("style",f.attr("style"));f.after(e);a.onload=function(a){f.hide();c.src=a.target.result};a.onloadend=function(){setTimeout(function(){e.Jcrop({bgColor:"#fff",minSize:[64,64],maxSize:[0,0],setSelect:[0,0,e.innerWidth(),e.innerHeight()],aspectRatio:1,onSelect:function(a){}},function(){g=this})},500)};a.readAsDataURL(h);c.style.width="100%";c.style.maxHeight="inherit";e.html(c);b.show();d.removeClass(".alert-success").removeClass(".alert-danger").hide()});
b.find("a").click(function(){var k=new XMLHttpRequest,m=new FormData,p=c.find(".progress"),n=c.find(".progress-bar"),q=n.find(".sr-only"),l=g.tellSelect(),l={x:Math.round(l.x),y:Math.round(l.y),w:Math.round(l.w),h:Math.round(l.h),portW:e.innerWidth(),portH:e.innerHeight()};m.append("img",h);m.append("token",a.token);m.append("dim",JSON.stringify(l));k.upload.onprogress=function(a){a.lengthComputable&&(a=Math.round(100*a.loaded/a.total),n.css("width",a+"%").attr("aria-valuenow",a),q.html(a+"%"))};
k.upload.onloadstart=function(a){p.show();n.css("width","0%").attr("aria-valuenow",0);q.html("0%")};k.upload.onload=function(a){p.hide();b.hide();d.addClass("alert-info").html("\u0424\u043e\u0442\u043e\u0433\u0440\u0430\u0444\u0438\u044f \u043e\u0431\u0440\u0430\u0431\u0430\u0442\u044b\u0432\u0430\u0435\u0442\u0441\u044f, \u043f\u043e\u0434\u043e\u0436\u0434\u0438\u0442\u0435...").show()};k.onload=function(b){d.removeClass("alert-info").removeClass("alert-danger");g.destroy();f.show();try{var c=JSON.parse(b.target.responseText)}catch(r){d.addClass("alert-danger").html("\u041f\u0440\u043e\u0438\u0437\u043e\u0448\u043b\u0430 \u0442\u0435\u0445\u043d\u0438\u0447\u0435\u0441\u043a\u0430\u044f \u043e\u0448\u0438\u0431\u043a\u0430").show();
return}200!=b.target.status?d.addClass("alert-danger").html(c.response).show():(d.addClass("alert-success").html(c.response).show(),a.send({subject:"Properties",action:"uploadAvatar",image:c.image}))};k.open("POST","/user/upload-avatar",!0);k.send(m)})}}});
